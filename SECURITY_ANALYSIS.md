# Backpack-MM-Simple å®‰å…¨åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ Backpack-MM-Simple é¡¹ç›®è¿›è¡Œäº†å…¨é¢çš„å®‰å…¨å®¡è®¡,è¯†åˆ«äº†å…³é”®é£é™©å¹¶å®æ–½äº†å®‰å…¨æ”¹è¿›æªæ–½ã€‚

**é¡¹ç›®ç±»å‹**: åŠ å¯†è´§å¸åšå¸‚æœºå™¨äºº
**æ”¯æŒäº¤æ˜“æ‰€**: Backpack, Aster, Paradex, Lighter
**æ ¸å¿ƒåŠŸèƒ½**: ç°è´§åšå¸‚ã€æ°¸ç»­åˆçº¦åšå¸‚ã€Maker-Takerå¯¹å†²
**å®¡è®¡æ—¥æœŸ**: 2025-11-14

---

## ä¸€ã€åŸå§‹å®‰å…¨é£é™©è¯†åˆ«

### 1.1 é«˜å±é£é™©

#### ğŸ”´ å¯†é’¥æ˜æ–‡å­˜å‚¨
**ä½ç½®**: `config.py`, `web/server.py`, ç¯å¢ƒå˜é‡
**é£é™©ç­‰çº§**: ä¸¥é‡

**é—®é¢˜æè¿°**:
- æ‰€æœ‰APIå¯†é’¥ç›´æ¥ä»ç¯å¢ƒå˜é‡è¯»å–,æ— åŠ å¯†ä¿æŠ¤
- ç§é’¥ä»¥Base64ç¼–ç å­˜å‚¨åœ¨ `.env` æ–‡ä»¶ä¸­
- WebæœåŠ¡å™¨ç›´æ¥ä½¿ç”¨ `os.getenv()` è·å–æ˜æ–‡å¯†é’¥

**æ½œåœ¨å½±å“**:
- ç³»ç»Ÿè¢«å…¥ä¾µæ—¶,æ”»å‡»è€…å¯ç›´æ¥è·å–æ‰€æœ‰äº¤æ˜“æ‰€APIå¯†é’¥
- å†…å­˜dumpå¯èƒ½æ³„éœ²å¯†é’¥
- æ—¥å¿—æ–‡ä»¶å¯èƒ½æ„å¤–è®°å½•å¯†é’¥ä¿¡æ¯

**ä»£ç ç¤ºä¾‹**:
```python
# web/server.py:102-103 (åŸå§‹ä»£ç )
api_key = os.getenv('BACKPACK_KEY', '')
secret_key = os.getenv('BACKPACK_SECRET', '')
```

---

#### ğŸ”´ Webæ¥å£æ— è®¤è¯
**ä½ç½®**: `web/server.py`
**é£é™©ç­‰çº§**: ä¸¥é‡

**é—®é¢˜æè¿°**:
- `/api/start`, `/api/stop` ç­‰å…³é”®æ¥å£æ— ä»»ä½•è®¤è¯
- CORSè®¾ç½®ä¸º `*`,å…è®¸ä»»ä½•åŸŸè®¿é—®
- æ— è¯·æ±‚é¢‘ç‡é™åˆ¶,æ˜“å—DoSæ”»å‡»
- SocketIOè¿æ¥æ— è®¤è¯éªŒè¯

**æ½œåœ¨å½±å“**:
- æœªæˆæƒç”¨æˆ·å¯å¯åŠ¨/åœæ­¢äº¤æ˜“æœºå™¨äºº
- æ¶æ„ç”¨æˆ·å¯ä¿®æ”¹äº¤æ˜“å‚æ•°
- å¯èƒ½é€ æˆèµ„é‡‘æŸå¤±

**ä»£ç ç¤ºä¾‹**:
```python
# web/server.py:28-36 (åŸå§‹ä»£ç )
socketio = SocketIO(
    app,
    cors_allowed_origins="*",  # âš ï¸ å…è®¸ä»»ä½•æº
    ...
)

@app.route('/api/start', methods=['POST'])
def start_bot():  # âš ï¸ æ— è®¤è¯ä¿æŠ¤
    ...
```

---

#### ğŸ”´ ç¼ºå°‘æ»‘ç‚¹ä¿æŠ¤
**ä½ç½®**: `strategies/perp_market_maker.py`
**é£é™©ç­‰çº§**: é«˜

**é—®é¢˜æè¿°**:
- å¸‚ä»·å•æ— ä»·æ ¼ä¸Šé™æ£€æŸ¥
- é™ä»·å•ä»·æ ¼æœªéªŒè¯åç¦»åº¦
- æœªæ£€æŸ¥è®¢å•ç°¿æµåŠ¨æ€§
- å¯èƒ½åœ¨å¼‚å¸¸å¸‚åœºæ¡ä»¶ä¸‹æˆäº¤äºæç«¯ä»·æ ¼

**æ½œåœ¨å½±å“**:
- åœ¨æµåŠ¨æ€§æ¯ç«­æ—¶é­å—å·¨å¤§æ»‘ç‚¹
- é—ªå´©æ—¶ä»¥æç«¯ä»·æ ¼æˆäº¤
- å¯èƒ½æŸå¤±å¤§é‡èµ„é‡‘

**ä»£ç ç¤ºä¾‹**:
```python
# strategies/perp_market_maker.py:395-465 (åŸå§‹ä»£ç )
def open_position(self, side, quantity, price=None, order_type="Limit", ...):
    ...
    # âš ï¸ æ— ä»·æ ¼åç¦»æ£€æŸ¥
    result = self.client.execute_order(order_details)
```

---

### 1.2 ä¸­å±é£é™©

#### ğŸŸ¡ Ed25519ç­¾åå®ç°
**ä½ç½®**: `api/auth.py`
**é£é™©ç­‰çº§**: ä¸­

**é—®é¢˜æè¿°**:
- ä½¿ç”¨PyNaClåº“è¿›è¡ŒEd25519ç­¾å
- ç­¾åå¤±è´¥æ—¶å¼ºåˆ¶ç»ˆæ­¢ç¨‹åº (`sys.exit(1)`)
- æ— å¯†é’¥è½®æ¢æœºåˆ¶

**å»ºè®®**:
- æ·»åŠ ç­¾åé‡è¯•æœºåˆ¶
- ä¼˜é›…å¤„ç†ç­¾åå¤±è´¥,ä¸åº”ç›´æ¥ç»ˆæ­¢
- å®ç°å¯†é’¥å®šæœŸè½®æ¢ç­–ç•¥

---

#### ğŸŸ¡ WebSocketè¿æ¥å®‰å…¨
**ä½ç½®**: `ws_client/client.py`
**é£é™©ç­‰çº§**: ä¸­

**é—®é¢˜æè¿°**:
- WebSocketè¿æ¥ä½¿ç”¨ä»£ç†æ—¶,æœªéªŒè¯ä»£ç†å®‰å…¨æ€§
- é‡è¿æœºåˆ¶å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±
- æ— æ¶ˆæ¯ç­¾åéªŒè¯

**å»ºè®®**:
- æ·»åŠ WebSocketæ¶ˆæ¯å®Œæ•´æ€§æ ¡éªŒ
- å®ç°æ¶ˆæ¯é˜Ÿåˆ—ç¡®ä¿ä¸ä¸¢å¤±
- éªŒè¯ä»£ç†è¯ä¹¦

---

### 1.3 ä½å±é£é™©

#### ğŸŸ¢ æ—¥å¿—æ•æ„Ÿä¿¡æ¯
**é£é™©ç­‰çº§**: ä½

**é—®é¢˜æè¿°**:
- æ—¥å¿—å¯èƒ½åŒ…å«äº¤æ˜“è¯¦æƒ…
- é”™è¯¯æ—¥å¿—å¯èƒ½æ³„éœ²ç³»ç»Ÿä¿¡æ¯

**å»ºè®®**:
- è„±æ•å¤„ç†æ•æ„Ÿæ•°æ®
- æ§åˆ¶æ—¥å¿—è¯¦ç»†çº§åˆ«
- å®šæœŸè½®è½¬å’ŒåŠ å¯†æ—¥å¿—æ–‡ä»¶

---

## äºŒã€å·²å®æ–½çš„å®‰å…¨æ”¹è¿›

### 2.1 å¯†é’¥åŠ å¯†å­˜å‚¨ âœ…

**å®ç°æ–‡ä»¶**: `security/encryption.py`

**æ ¸å¿ƒåŠŸèƒ½**:
1. ä½¿ç”¨ PBKDF2 + SHA256 ä»ä¸»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥
2. ä½¿ç”¨ Fernet (AES-128-CBC + HMAC) åŠ å¯†å­˜å‚¨
3. å¯†é’¥åº“æ–‡ä»¶æƒé™è®¾ç½®ä¸º `0o600` (ä»…æ‰€æœ‰è€…å¯è¯»å†™)
4. æ”¯æŒå¤šäº¤æ˜“æ‰€å‡­è¯ç®¡ç†

**ä½¿ç”¨æ–¹æ³•**:
```bash
# è¿ç§»ç°æœ‰ç¯å¢ƒå˜é‡åˆ°åŠ å¯†å­˜å‚¨
export MASTER_PASSWORD="your-secure-password"
python security/encryption.py migrate

# åœ¨ä»£ç ä¸­ä½¿ç”¨
from security import KeyEncryption

encryptor = KeyEncryption(master_password="your-password")
creds = encryptor.load_credentials('backpack')
api_key = creds['api_key']
secret_key = creds['secret_key']
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… 100,000æ¬¡PBKDF2è¿­ä»£
- âœ… æ–‡ä»¶æƒé™è‡ªåŠ¨è®¾ç½®
- âœ… æ”¯æŒå‡­è¯å¢åˆ æ”¹æŸ¥
- âœ… åŠ å¯†é”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸,ä¸é™é»˜å¤±è´¥

---

### 2.2 Webè®¤è¯æœºåˆ¶ âœ…

**å®ç°æ–‡ä»¶**: `security/auth.py`, `web/server.py`

**æ ¸å¿ƒåŠŸèƒ½**:
1. åŸºäºTokençš„æ— çŠ¶æ€è®¤è¯
2. å¯†ç SHA256å“ˆå¸Œå­˜å‚¨
3. Tokenè‡ªåŠ¨è¿‡æœŸ (é»˜è®¤24å°æ—¶)
4. è¯·æ±‚é¢‘ç‡é™åˆ¶

**APIç«¯ç‚¹**:

```bash
# ç™»å½•
POST /api/login
Content-Type: application/json
{
  "username": "admin",
  "password": "your-password"
}

# å“åº”
{
  "success": true,
  "token": "secure-token-here",
  "message": "ç™»å½•æˆåŠŸ"
}

# ä½¿ç”¨Tokenè®¿é—®å—ä¿æŠ¤çš„API
POST /api/start
Authorization: Bearer secure-token-here
Content-Type: application/json
{ ... }

# ç™»å‡º
POST /api/logout
Authorization: Bearer secure-token-here
```

**å—ä¿æŠ¤çš„ç«¯ç‚¹**:
- âœ… `/api/start` - å¯åŠ¨æœºå™¨äºº (3æ¬¡/åˆ†é’Ÿé™åˆ¶)
- âœ… `/api/stop` - åœæ­¢æœºå™¨äºº (5æ¬¡/åˆ†é’Ÿé™åˆ¶)
- âœ… `/api/login` - ç™»å½• (5æ¬¡/åˆ†é’Ÿé™åˆ¶)

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# .env
ADMIN_USERNAME=admin  # å¯é€‰,é»˜è®¤admin
ADMIN_PASSWORD=your-secure-password  # å¿…é¡»è®¾ç½®
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… å¯†ç å“ˆå¸Œå­˜å‚¨ (SHA256)
- âœ… Tokenå®šæ—¶æ¸…ç†
- âœ… åŸºäºIPçš„é€Ÿç‡é™åˆ¶
- âœ… å®‰å…¨çš„Tokenç”Ÿæˆ (`secrets.token_urlsafe`)
- âœ… å¸¸æ•°æ—¶é—´å¯†ç æ¯”è¾ƒ (`secrets.compare_digest`)

---

### 2.3 æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶ âœ…

**å®ç°æ–‡ä»¶**: `utils/slippage_protection.py`, `strategies/perp_market_maker.py`

**æ ¸å¿ƒåŠŸèƒ½**:
1. ä»·æ ¼åç¦»æ£€æµ‹
2. è®¢å•ç°¿æµåŠ¨æ€§éªŒè¯
3. å¸‚ä»·å•ä»·å·®æ£€æŸ¥
4. é™ä»·å•æ»‘ç‚¹ä¿æŠ¤

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from strategies.perp_market_maker import PerpetualMarketMaker

# åˆ›å»ºç­–ç•¥æ—¶å¯ç”¨æ»‘ç‚¹ä¿æŠ¤
strategy = PerpetualMarketMaker(
    api_key=api_key,
    secret_key=secret_key,
    symbol='SOL-PERP',
    max_slippage_bps=50,  # æœ€å¤§æ»‘ç‚¹0.5%
    enable_slippage_protection=True
)
```

**ä¿æŠ¤æœºåˆ¶**:

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è§¦å‘åŠ¨ä½œ |
|--------|------|----------|
| é™ä»·å•ä»·æ ¼åç¦» | 50bp (0.5%) | æ‹’ç»è®¢å• |
| å¸‚ä»·å•ä»·å·® | 100bp (1%) | æ‹’ç»è®¢å• |
| è®¢å•ç°¿æ·±åº¦ | 100% | è­¦å‘Šå¹¶æ‹’ç» |

**æ—¥å¿—ç¤ºä¾‹**:
```
[INFO] æ»‘ç‚¹ä¿æŠ¤å·²å¯ç”¨: æœ€å¤§æ»‘ç‚¹ 50bp (0.50%)
[DEBUG] ä»·æ ¼åç¦»æ£€æŸ¥é€šè¿‡: 0.23% (å‚è€ƒ: 145.320, æ‰§è¡Œ: 145.650, buy)
[ERROR] ä»·æ ¼åç¦»è¿‡å¤§: 0.82% (é™åˆ¶: 0.50%) - æ‹’ç»è®¢å•
[WARNING] å¸‚ä»·å•ä»·å·®è¿‡å¤§: 150bp (é™åˆ¶: 100bp)
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… åŒå‘æ»‘ç‚¹æ£€æµ‹ (ä¹°/å–)
- âœ… åŠ¨æ€è°ƒæ•´æ»‘ç‚¹é˜ˆå€¼
- âœ… æµåŠ¨æ€§æ·±åº¦æ£€æŸ¥
- âœ… å¯è¿è¡Œæ—¶å¼€å…³

---

## ä¸‰ã€æ°¸ç»­åšå¸‚æ ¸å¿ƒé€»è¾‘

### 3.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PerpetualMarketMaker (æ°¸ç»­åšå¸‚ç­–ç•¥)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MarketMaker (åŸºç¡€åšå¸‚)                                   â”‚
â”‚  â”œâ”€ è®¢å•ç®¡ç†                                              â”‚
â”‚  â”œâ”€ ç›ˆäºè®¡ç®—                                              â”‚
â”‚  â””â”€ WebSocketæˆäº¤å¤„ç†                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ°¸ç»­åˆçº¦æ‰©å±•                                             â”‚
â”‚  â”œâ”€ ä»“ä½ç®¡ç† (target_position, max_position)            â”‚
â”‚  â”œâ”€ é£é™©ä¸­æ€§æŠ¥ä»· (inventory_skew)                        â”‚
â”‚  â”œâ”€ æ­¢æŸæ­¢ç›ˆ (stop_loss, take_profit)                   â”‚
â”‚  â””â”€ æ æ†æ§åˆ¶ (leverage)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä»“ä½ç®¡ç†é€»è¾‘

**æ ¸å¿ƒå‚æ•°**:
- `target_position`: ç›®æ ‡æŒä»“é‡(ç»å¯¹å€¼),å¦‚1.0 SOL
- `max_position`: æœ€å¤§æŒä»“é™é¢,å¦‚5.0 SOL
- `position_threshold`: è§¦å‘è°ƒæ•´çš„é˜ˆå€¼,å¦‚0.1 SOL

**ä»“ä½æ§åˆ¶æµç¨‹**:
```python
# ä»£ç ä½ç½®: perp_market_maker.py:574-642

if current_size > max_position:
    # é£æ§: è¶…è¿‡æœ€å¤§æŒä»“,ç´§æ€¥å¹³ä»“
    excess = current_size - max_position
    close_position(quantity=excess, order_type="Market")

elif current_size > (target_position + threshold):
    # å‡ä»“: æŒä»“è¶…è¿‡ç›®æ ‡+é˜ˆå€¼,éƒ¨åˆ†å¹³ä»“
    to_close = current_size - (target_position + threshold)
    close_position(quantity=to_close, order_type="Market")

# å¼€ä»“ç”±æŠ¥ä»·è‡ªç„¶æˆäº¤å®Œæˆ,ä¸ä¸»åŠ¨å¼€ä»“
```

**ç¤ºä¾‹**:
```
ç›®æ ‡æŒä»“: 1.0 SOL
é˜ˆå€¼: 0.1 SOL
æœ€å¤§æŒä»“: 5.0 SOL

å½“å‰æŒä»“: 1.05 SOL â†’ æ­£å¸¸,æ— æ“ä½œ
å½“å‰æŒä»“: 1.2 SOL â†’ å‡ä»“ 0.1 SOL (è¶…è¿‡1.0+0.1)
å½“å‰æŒä»“: 5.5 SOL â†’ ç´§æ€¥å¹³ä»“ 0.5 SOL (è¶…è¿‡æœ€å¤§)
```

---

### 3.3 é£é™©ä¸­æ€§æŠ¥ä»· (Inventory Skew)

**ç›®æ ‡**: é€šè¿‡ä¸å¯¹ç§°æŠ¥ä»·å°†å‡€ä»“ä½æ¨å‘0,å®ç°Deltaä¸­æ€§

**ä»·æ ¼è°ƒæ•´å…¬å¼**:
```python
# ä»£ç ä½ç½®: perp_market_maker.py:654-727

deviation = net_position
skew_ratio = deviation / max_position  # èŒƒå›´: [-1, 1]
skew_offset = current_price * inventory_skew * skew_ratio

# è°ƒæ•´æŠ¥ä»·
adjusted_buy_price = original_buy_price - skew_offset
adjusted_sell_price = original_sell_price - skew_offset
```

**å·¥ä½œåŸç†**:

| å‡€ä»“ä½ | Skewæ–¹å‘ | æŠ¥ä»·è°ƒæ•´ | æ•ˆæœ |
|--------|----------|----------|------|
| +2 SOL (å¤šå¤´) | æ­£åç§» | ä¹°å–ä»·â†“ | é¼“åŠ±å¸‚åœºåƒå–å•,å‡å°‘å¤šå¤´ |
| -2 SOL (ç©ºå¤´) | è´Ÿåç§» | ä¹°å–ä»·â†‘ | é¼“åŠ±å¸‚åœºåƒä¹°å•,å‡å°‘ç©ºå¤´ |
| 0 (ä¸­æ€§) | 0 | æ— è°ƒæ•´ | å¯¹ç§°æŠ¥ä»· |

**å®é™…æ¡ˆä¾‹**:
```
å½“å‰ä»·æ ¼: 145.00
å‡€æŒä»“: +2.0 SOL (å¤šå¤´)
inventory_skew: 0.002
max_position: 5.0

skew_ratio = 2.0 / 5.0 = 0.4
skew_offset = 145 * 0.002 * 0.4 = 0.116

åŸå§‹æŠ¥ä»·: ä¹°144.85 / å–145.15
è°ƒæ•´å: ä¹°144.73 / å–145.03  (å‡ä¸‹è°ƒ0.116)

â†’ å–å•æ›´æœ‰ç«äº‰åŠ›,æ›´å®¹æ˜“æˆäº¤,å‡å°‘å¤šå¤´æŒä»“
```

---

### 3.4 æ­¢æŸæ­¢ç›ˆæœºåˆ¶

**ä»£ç ä½ç½®**: `perp_market_maker.py:315-391`

**è§¦å‘é€»è¾‘**:
```python
unrealized_pnl = position_state['unrealized']

if stop_loss and unrealized_pnl <= -stop_loss:
    # æ­¢æŸ: å¸‚ä»·å…¨éƒ¨å¹³ä»“
    cancel_existing_orders()
    close_position(order_type="Market")

elif take_profit and unrealized_pnl >= take_profit:
    # æ­¢ç›ˆ: å¸‚ä»·å…¨éƒ¨å¹³ä»“
    cancel_existing_orders()
    close_position(order_type="Market")
```

**PnLè®¡ç®—**:
1. ä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„ `pnlUnrealized`
2. å¦‚æœAPIè¿”å›0ä½†æœ‰ä»“ä½,æ‰‹åŠ¨è®¡ç®—:
   ```python
   if net > 0:  # å¤šå¤´
       pnl = (current_price - entry_price) * net
   else:  # ç©ºå¤´
       pnl = (entry_price - current_price) * abs(net)
   ```

**å…³é”®ç‰¹æ€§**:
- âœ… æ¯æ¬¡å¾ªç¯å¼ºåˆ¶æ›´æ–°ä»“ä½çŠ¶æ€
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•æ£€æŸ¥è¿‡ç¨‹
- âœ… å¹³ä»“å¤±è´¥æ—¶åœæ­¢ç­–ç•¥
- âœ… æ”¯æŒä»…æ­¢æŸ/ä»…æ­¢ç›ˆ/åŒæ—¶å¯ç”¨

---

### 3.5 å®Œæ•´äº¤æ˜“æµç¨‹

```
1. è·å–å¸‚åœºæ•°æ®
   â”œâ”€ ç›˜å£ä»·æ ¼ (best_bid, best_ask)
   â”œâ”€ å½“å‰ä»“ä½ (net_position via API)
   â””â”€ æœªå®ç°ç›ˆäº (pnlUnrealized via API)

2. é£é™©æ£€æŸ¥
   â”œâ”€ æ­¢æŸæ­¢ç›ˆæ£€æŸ¥ â†’ è§¦å‘åˆ™å¹³ä»“å¹¶ç»§ç»­
   â”œâ”€ ä»“ä½é™é¢æ£€æŸ¥ â†’ è¶…é™åˆ™å‡ä»“
   â””â”€ æ»‘ç‚¹ä¿æŠ¤æ£€æŸ¥ â†’ ä¸é€šè¿‡åˆ™æ‹’ç»

3. æŠ¥ä»·è®¡ç®—
   â”œâ”€ åŸºç¡€ä»·å·® (base_spread_percentage)
   â”œâ”€ Inventory Skewè°ƒæ•´ (æ ¹æ®å‡€ä»“ä½)
   â””â”€ é˜²æ­¢ä»·æ ¼äº¤å‰æ£€æŸ¥

4. è®¢å•æäº¤
   â”œâ”€ å–æ¶ˆæ—§è®¢å•
   â”œâ”€ æäº¤æ–°è®¢å• (å¸¦æ»‘ç‚¹ä¿æŠ¤)
   â””â”€ ç­‰å¾…æˆäº¤

5. æˆäº¤å¤„ç†
   â”œâ”€ WebSocketæ¨é€æˆäº¤
   â”œâ”€ æ›´æ–°ä»“ä½çŠ¶æ€
   â”œâ”€ è®°å½•äº¤æ˜“å†å²
   â””â”€ è®¡ç®—å®æ—¶ç›ˆäº
```

---

## å››ã€Backpacké›†æˆå®‰å…¨åˆ†æ

### 4.1 è®¤è¯æœºåˆ¶

**ç­¾åç®—æ³•**: Ed25519 æ¤­åœ†æ›²çº¿ç­¾å

**å®ç°ä»£ç **: `api/auth.py:12-33`
```python
def create_signature(secret_key: str, message: str) -> str:
    decoded_key = base64.b64decode(secret_key)
    signing_key = nacl.signing.SigningKey(decoded_key)
    signature = signing_key.sign(message.encode('utf-8')).signature
    return base64.b64encode(signature).decode('utf-8')
```

**HTTPå¤´æ ¼å¼**:
```
X-API-KEY: {api_key}
X-SIGNATURE: {base64_signature}
X-TIMESTAMP: {unix_timestamp_ms}
X-WINDOW: {validity_window_ms}
```

**ç­¾åæ¶ˆæ¯æ„é€ **:
```python
# api/bp_client.py:67-76
instruction = "orderExecute"  # APIæŒ‡ä»¤
timestamp = int(time.time() * 1000)
window = 5000  # 5ç§’æœ‰æ•ˆæœŸ

sign_message = f"instruction={instruction}&timestamp={timestamp}&window={window}"
signature = create_signature(secret_key, sign_message)
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… Ed25519æä¾›å¼ºåŠ å¯†ä¿è¯
- âœ… æ—¶é—´çª—å£é˜²æ­¢é‡æ”¾æ”»å‡»
- âœ… æ¯æ¬¡è¯·æ±‚ç‹¬ç«‹ç­¾å

**æ½œåœ¨é£é™©**:
- âš ï¸ ç­¾åå¤±è´¥æ—¶ç›´æ¥`sys.exit(1)`,è¿‡äºæ¿€è¿›
- âš ï¸ æ— ç­¾åé‡è¯•æœºåˆ¶
- âš ï¸ å¯†é’¥æ— å®šæœŸè½®æ¢

---

### 4.2 APIç«¯ç‚¹å®‰å…¨

**å·²å®ç°çš„ç«¯ç‚¹** (12ä¸ª):
```
GET  /api/v1/capital                    # è´¦æˆ·ä½™é¢ âœ“
GET  /api/v1/markets                    # å¸‚åœºä¿¡æ¯ âœ“
GET  /api/v1/depth                      # è®¢å•ç°¿ âœ“
POST /api/v1/order                      # ä¸‹å• âœ“ éœ€ç­¾å
GET  /api/v1/orders                     # æŸ¥è¯¢è®¢å• âœ“
DELETE /api/v1/order                    # æ’¤å• âœ“ éœ€ç­¾å
DELETE /api/v1/orders                   # æ‰¹é‡æ’¤å• âœ“ éœ€ç­¾å
GET  /api/v1/fills                      # æˆäº¤å†å² âœ“
GET  /api/v1/positions                  # æŒä»“æŸ¥è¯¢ âœ“
GET  /api/v1/funding_payments           # èµ„é‡‘è´¹ç‡ âœ“
GET  /api/v1/funding                    # å†å²è´¹ç‡ âœ“
GET  /api/v1/collateral                 # ä¿è¯é‡‘ âœ“
```

**é”™è¯¯å¤„ç†**:
```python
# api/bp_client.py:100-119
if response.status_code == 404:
    return {"error": "RESOURCE_NOT_FOUND"}
elif response.status_code == 401:
    return {"error": "UNAUTHORIZED"}
elif response.status_code >= 500:
    return {"error": "SERVER_ERROR"}
```

**é‡è¯•æœºåˆ¶**:
- é»˜è®¤3æ¬¡é‡è¯•
- æŒ‡æ•°é€€é¿ (1s, 2s, 4s)
- ä»…å¯¹5xxé”™è¯¯é‡è¯•

---

### 4.3 WebSocketå®‰å…¨

**è¿æ¥URL**: `wss://ws.backpack.exchange`

**è®¢é˜…æ¶ˆæ¯**:
```json
{
  "method": "SUBSCRIBE",
  "params": ["fills.{symbol}"],
  "id": 1
}
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… TLS/SSLåŠ å¯†
- âœ… å¿ƒè·³æ£€æµ‹ (60ç§’)
- âœ… è‡ªåŠ¨é‡è¿
- âœ… ä»£ç†æ”¯æŒ

**æ½œåœ¨é£é™©**:
- âš ï¸ æ— æ¶ˆæ¯ç­¾åéªŒè¯
- âš ï¸ é‡è¿æ—¶å¯èƒ½ä¸¢å¤±æ¶ˆæ¯
- âš ï¸ ä»£ç†æœªéªŒè¯è¯ä¹¦

---

## äº”ã€å®‰å…¨å»ºè®®ä¸æœ€ä½³å®è·µ

### 5.1 ç«‹å³å®æ–½

#### 1. å¯ç”¨å¯†é’¥åŠ å¯†å­˜å‚¨
```bash
# 1. è®¾ç½®ä¸»å¯†ç 
export MASTER_PASSWORD="your-strong-password-here"

# 2. è¿ç§»ç°æœ‰å¯†é’¥
python security/encryption.py migrate

# 3. ä¿®æ”¹ä»£ç ä½¿ç”¨åŠ å¯†å­˜å‚¨
from security import KeyEncryption

encryptor = KeyEncryption()
creds = encryptor.load_credentials('backpack')
```

#### 2. é…ç½®Webè®¤è¯
```bash
# .env
ADMIN_USERNAME=admin
ADMIN_PASSWORD=generate-strong-password-here
```

#### 3. å¯ç”¨æ»‘ç‚¹ä¿æŠ¤
```python
strategy = PerpetualMarketMaker(
    ...,
    max_slippage_bps=50,  # 0.5%
    enable_slippage_protection=True
)
```

---

### 5.2 çŸ­æœŸæ”¹è¿› (1-2å‘¨)

1. **æ—¥å¿—è„±æ•**
   - è¿‡æ»¤APIå¯†é’¥
   - éšè—è®¢å•è¯¦æƒ…
   - åŠ å¯†å­˜å‚¨æ—¥å¿—

2. **ç›‘æ§å‘Šè­¦**
   - å¼‚å¸¸ç™»å½•æ£€æµ‹
   - å¤§é¢äº¤æ˜“å‘Šè­¦
   - APIé”™è¯¯ç‡ç›‘æ§

3. **å¤‡ä»½æ¢å¤**
   - å®šæœŸå¤‡ä»½å¯†é’¥åº“
   - æ•°æ®åº“å¤‡ä»½
   - ç¾éš¾æ¢å¤æ¼”ç»ƒ

---

### 5.3 ä¸­æœŸæ”¹è¿› (1-2æœˆ)

1. **å¤šå› ç´ è®¤è¯ (MFA)**
   - TOTPæ”¯æŒ
   - ç¡¬ä»¶å¯†é’¥
   - çŸ­ä¿¡éªŒè¯

2. **å®¡è®¡æ—¥å¿—**
   - è®°å½•æ‰€æœ‰æ“ä½œ
   - ä¸å¯ç¯¡æ”¹æ—¥å¿—
   - å®šæœŸå®¡æŸ¥

3. **å¯†é’¥è½®æ¢**
   - å®šæœŸæ›´æ¢APIå¯†é’¥
   - è‡ªåŠ¨åŒ–è½®æ¢æµç¨‹
   - é›¶åœæœºè¿ç§»

---

### 5.4 é•¿æœŸæ”¹è¿› (3-6æœˆ)

1. **ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM)**
   - å¯†é’¥å­˜å‚¨åœ¨HSM
   - ç­¾ååœ¨HSMå†…å®Œæˆ
   - ç¬¦åˆé‡‘èçº§å®‰å…¨

2. **é›¶çŸ¥è¯†è¯æ˜**
   - éšç§äº¤æ˜“
   - é“¾ä¸ŠéªŒè¯
   - æ— éœ€æš´éœ²ç­–ç•¥

3. **å½¢å¼åŒ–éªŒè¯**
   - æ•°å­¦è¯æ˜ç®—æ³•æ­£ç¡®æ€§
   - è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥
   - æ¼æ´é¢„é˜²

---

## å…­ã€åˆè§„æ€§è€ƒè™‘

### 6.1 æ•°æ®ä¿æŠ¤

- **GDPR**: å¦‚æ¶‰åŠæ¬§ç›Ÿç”¨æˆ·,éœ€å®ç°æ•°æ®åˆ é™¤æƒ
- **åŠ å¯†ä¼ è¾“**: æ‰€æœ‰APIé€šä¿¡ä½¿ç”¨TLS 1.2+
- **æ•°æ®æœ€å°åŒ–**: ä»…æ”¶é›†å¿…è¦çš„äº¤æ˜“æ•°æ®

### 6.2 é‡‘èç›‘ç®¡

- **KYC/AML**: ç¡®ä¿ç¬¦åˆäº¤æ˜“æ‰€KYCè¦æ±‚
- **äº¤æ˜“è®°å½•**: ä¿ç•™å®Œæ•´å®¡è®¡è½¨è¿¹
- **é£é™©æŠ«éœ²**: æ˜ç¡®æ ‡æ³¨äº¤æ˜“é£é™©

---

## ä¸ƒã€äº‹ä»¶å“åº”è®¡åˆ’

### 7.1 å¯†é’¥æ³„éœ²

**æ­¥éª¤**:
1. ç«‹å³æ’¤é”€APIå¯†é’¥ (äº¤æ˜“æ‰€åå°)
2. ç”Ÿæˆæ–°å¯†é’¥å¹¶æ›´æ–°åŠ å¯†å­˜å‚¨
3. å®¡æŸ¥è¿‘æœŸäº¤æ˜“è®°å½•
4. æ£€æŸ¥è´¦æˆ·ä½™é¢
5. è°ƒæŸ¥æ³„éœ²æºå¤´

### 7.2 æœªæˆæƒè®¿é—®

**æ­¥éª¤**:
1. æ’¤é”€æ‰€æœ‰æ´»è·ƒToken
2. åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„ç­–ç•¥
3. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
4. ä¿®æ”¹æ‰€æœ‰å¯†ç 
5. åŠ å¼ºé˜²ç«å¢™è§„åˆ™

### 7.3 å¼‚å¸¸äº¤æ˜“

**æ­¥éª¤**:
1. ç«‹å³åœæ­¢ç­–ç•¥
2. å–æ¶ˆæ‰€æœ‰æŒ‚å•
3. å¹³ä»“æ‰€æœ‰æŒä»“
4. è”ç³»äº¤æ˜“æ‰€å®¢æœ
5. åˆ†æäº¤æ˜“è®°å½•

---

## å…«ã€æ€»ç»“

### å·²å®Œæˆçš„å®‰å…¨æ”¹è¿›

| æ¨¡å— | çŠ¶æ€ | æ–‡ä»¶ |
|------|------|------|
| å¯†é’¥åŠ å¯†å­˜å‚¨ | âœ… | `security/encryption.py` |
| Webè®¤è¯æœºåˆ¶ | âœ… | `security/auth.py` |
| é€Ÿç‡é™åˆ¶ | âœ… | `web/server.py` |
| æ»‘ç‚¹ä¿æŠ¤ | âœ… | `utils/slippage_protection.py` |
| æ°¸ç»­åšå¸‚ä¼˜åŒ– | âœ… | `strategies/perp_market_maker.py` |

### é£é™©çŸ©é˜µ

| é£é™© | åŸå§‹ç­‰çº§ | ç°åœ¨ç­‰çº§ | å‰©ä½™å·¥ä½œ |
|------|----------|----------|----------|
| å¯†é’¥æ³„éœ² | ğŸ”´ ä¸¥é‡ | ğŸŸ¡ ä¸­ç­‰ | å®æ–½HSM |
| æœªæˆæƒè®¿é—® | ğŸ”´ ä¸¥é‡ | ğŸŸ¢ ä½ | æ·»åŠ MFA |
| æ»‘ç‚¹æŸå¤± | ğŸŸ¡ é«˜ | ğŸŸ¢ ä½ | ä¼˜åŒ–ç®—æ³• |
| APIé™æµ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | æ—  |
| æ—¥å¿—æ³„éœ² | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | è„±æ•å¤„ç† |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**: å¯ç”¨æ‰€æœ‰å®‰å…¨æ¨¡å—å¹¶æµ‹è¯•
2. **æœ¬å‘¨**: å®æ–½æ—¥å¿—è„±æ•å’Œç›‘æ§å‘Šè­¦
3. **æœ¬æœˆ**: å®Œæˆå¯†é’¥è½®æ¢æµç¨‹
4. **æœ¬å­£åº¦**: è¯„ä¼°HSMæ–¹æ¡ˆ

---

## é™„å½•

### A. ä¾èµ–åŒ…å®‰å…¨æ‰«æ

**éœ€è¦æ·»åŠ çš„ä¾èµ–**:
```txt
cryptography>=41.0.0  # å¯†é’¥åŠ å¯†
PyNaCl>=1.5.0        # Ed25519ç­¾å
```

**å»ºè®®å®šæœŸè¿è¡Œ**:
```bash
pip install safety
safety check
```

### B. ç¯å¢ƒå˜é‡æ¸…å•

```bash
# è®¤è¯
ADMIN_USERNAME=admin
ADMIN_PASSWORD=<strong-password>
MASTER_PASSWORD=<master-password>

# Backpack
BACKPACK_KEY=<from-encrypted-store>
BACKPACK_SECRET=<from-encrypted-store>

# å…¶ä»–äº¤æ˜“æ‰€...
```

### C. å‚è€ƒæ–‡æ¡£

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CryptoCurrency Security Standard](https://cryptoconsortium.github.io/CCSS/)
- [Backpack API Docs](https://docs.backpack.exchange/)

---

**æŠ¥å‘Šç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-14
**å®¡è®¡äººå‘˜**: Claude (Anthropic AI)
